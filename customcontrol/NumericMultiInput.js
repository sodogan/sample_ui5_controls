/*
 * Copyright (C) 2009-2018 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/m/MultiInput","sap/m/Token","i2d/qm/inspresults/records1/util/NumberFormat","i2d/qm/inspresults/records1/model/formatter","i2d/qm/inspresults/records1/util/CalculationHelper",],function(M,T,N,f,C){"use strict";return M.extend("i2d.qm.inspresults.records1.customcontrol.NumericMultiInput",{metadata:{properties:{"originalCount":{type:"int"},"removedItems":{type:"object",defaultValue:[]},},events:{"numericChange":{}}},renderer:{},init:function(){this._bInitialLoading=true;this.detailGeneralKeys=["Inspectionresultattribute","Inspspecrecordingtype","Inspectionresulttext","Insprsltfreedefinedtestequip","Inspresultiteminternalid","Inspectionresultoriginalvalue","CharacteristicAttributeCode","CharacteristicAttributeCodeGrp","Inspectionresultmeasuredvalue","Inspectionresultitem"];this.setRemovedItems([]);M.prototype.init.apply(this,arguments);},onBeforeRendering:function(){M.prototype.onBeforeRendering.apply(this,arguments);},reset:function(){var b=this.getBindingContext().getObject();this.setOriginalCount(b.Inspresultvaluecount);var t=this.getTokens();for(var i in b.to_ResultDetails.results4Binding){t[i].setKey(b.to_ResultDetails.results4Binding[i].Inspresultiteminternalid);}},calculationHelper:C,_validator:function(a){var i=a.text;var b=this.getBindingContext().getObject();var v=N.getFloatInstance().parse(i);if(isNaN(v)||v>999999999.99){this.setValueState("Error");return false;}else{i=N.getFloatInstance().format(v);this.setValueState("None");}var t=new T({key:++b.Inspresultvaluecount,text:i});a.asyncCallback(t);return M.WaitForAsyncValidation;},_tokenUpdate:function(e){var o=sap.m.Tokenizer.TokenUpdateType;var E=e.getParameter("type");var a;if(E===o.Removed){a=e.getParameter("removedTokens")[0];}else if(E===o.Added){a=e.getParameter("addedTokens")[0];}else{return;}var b=this.getBindingContext()&&this.getBindingContext().getObject()||{};var F=N.getFloatInstance({decimals:b.Inspspecdecimalplaces});var v="";if(a&&a.getText()){v=F.format(F.parse(a.getText()));a.setText(v);}var V=this.getTokens().map(function(t){return F.parse(t.getText());});if(!this.getBindingContext()){return;}var r=this.getBindingContext().getObject().to_ResultDetails.results4Binding;var c;if(E===o.Added){c=r.length;var R={};this.detailGeneralKeys.forEach(function(n){R[n]=b[n]||"";});r[c]=R;r[c].Inspectionresultoriginalvalue=v;r[c].Inspectionresultmeasuredvalue=v;r[c].Inspresultiteminternalid=""+b.Inspresultvaluecount;}else if(E===o.Removed){for(var i=0;i<r.length;i++){var d=parseInt(a.getKey(),10);var g=parseInt(r[i].Inspresultiteminternalid,10);if(d===g){c=i;break;}}var h=r[c];r.splice(c,1);var j=parseInt(a.getKey(),10)<=this.getOriginalCount();if(j){var k=this.getRemovedItems();k.push(JSON.parse(JSON.stringify(h)));}}this.fireNumericChange({"values":V,"type":E,"item":{"formattedValue":v,"value":F.parse(a.getText()),"key":a.getKey(),}});},onAfterRendering:function(){if(this._bInitialLoading){var l=this.getParent().getContent()[0]&&this.getParent().getContent()[0].getId();if(l){this.addAriaLabelledBy(l);}this.addValidator(this._validator.bind(this));this.attachTokenUpdate(this._tokenUpdate);var b=this.getBindingContext()&&this.getBindingContext().getObject()||{};this.setOriginalCount(b.Inspresultvaluecount);this._bInitialLoading=false;}M.prototype.onAfterRendering.apply(this,arguments);}});});
