/*
 * Copyright (C) 2009-2018 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/m/MultiInput","sap/m/Token","sap/ui/model/json/JSONModel","sap/ui/model/odata/v2/ODataModel","sap/ui/model/Filter","sap/ui/model/Sorter","i2d/qm/inspresults/records1/model/formatter"],function(M,T,J,O,F,S,f){return M.extend("i2d.qm.inspresults.records1.customcontrol.ValuationMultiInput",{metadata:{properties:{"originalCount":{type:"int"},"validCount":{type:"int"},"removedItems":{type:"object",defaultValue:[]}},events:{"valueChange":{}}},renderer:{},init:function(){this._bInitialLoading=true;this.detailGeneralKeys=["Inspectionresultattribute","Inspspecrecordingtype","Inspectionresulttext","Insprsltfreedefinedtestequip","Inspresultiteminternalid","Inspectionresultoriginalvalue","CharacteristicAttributeCode","CharacteristicAttributeCodeGrp","Inspectionresultmeasuredvalue","Inspectionresultitem"];this.setRemovedItems([]);M.prototype.init.apply(this,arguments);},onBeforeRendering:function(){M.prototype.onBeforeRendering.apply(this,arguments);},onAfterRendering:function(){if(this._bInitialLoading){var l=this.getParent().getContent()[0]&&this.getParent().getContent()[0].getId();if(l){this.addAriaLabelledBy(l);}this._oResourceBundle=this.getModel("i18n").getResourceBundle();this._valuationItems=[{ValuationKey:"A",ValuationName:this._oResourceBundle.getText("QM_ACCEPTED")},{ValuationKey:"R",ValuationName:this._oResourceBundle.getText("QM_REJECTED")}];this._suggestModel=new J(this._valuationItems);this._valueHelpModel=new J(this._valuationItems);this.setModel(this._suggestModel,"suggestModel");this.setModel(this._valueHelpModel,"valueHelpModel");var b=this.getBindingContext()&&this.getBindingContext().getObject()||{};this.setOriginalCount(b.Inspresultvaluecount);this.setValidCount(b.InspResultValidValuesNumber);this.attachTokenUpdate(this._tokenUpdate);this.attachSuggest(this._suggest);this.attachValueHelpRequest(this._performValueHelp);this.attachSuggestionItemSelected(this._onSelect);this.attachChange(this._validator.bind(this));this.addValidator(this._validator.bind(this));this._bInitialLoading=false;}M.prototype.onAfterRendering.apply(this,arguments);},_validator:function(a){var i=a.text?a.text.toLowerCase():this.getValue().toLowerCase();var b=this.getBindingContext().getObject();var A=this._valuationItems[0].ValuationName;var r=this._valuationItems[1].ValuationName;if(i===A.toLowerCase()){i=A;}else if(i===r.toLowerCase()){i=r;}else{this.setValue();return M.WaitForAsyncValidation;}if(a.text){var t=new T({key:++b.Inspresultvaluecount,text:i});a.asyncCallback(t);}return M.WaitForAsyncValidation;},_tokenUpdate:function(e){var E=e.getParameter("type");var o=sap.m.Tokenizer.TokenUpdateType;if(E!==o.Added&&E!==o.Removed){return;}if(!e.getSource().getBindingContext()||!this.getBindingContext()){return;}var V=this.getTokens().map(function(t){return t.getText();});var b=this.getBindingContext()&&this.getBindingContext().getObject()||{};var a;var k;var s;var r=this.getBindingContext().getObject().to_ResultDetails.results4Binding;if(E===o.Added){a=e.getParameter("addedTokens")[0];k=a.getKey();s=a.getText();var c=r.length;var R={};this.detailGeneralKeys.forEach(function(n){R[n]=b[n]||"";});r[c]=R;var d=r[c];var C="";this._valuationItems.forEach(function(v){if(s===v.ValuationName){C=v.ValuationKey;}});d.Inspectionvaluationresult=C;d.Inspresultiteminternalid=""+b.Inspresultvaluecount;this.setValidCount(this.getValidCount()+1);}else if(E===o.Removed){a=e.getParameter("removedTokens")[0];k=a.getKey();s=a.getText();for(var i=0;i<r.length;i++){var g=parseInt(a.getKey(),10);var h=parseInt(r[i].Inspresultiteminternalid,10);if(g===h){c=i;break;}}var j=r[c];r.splice(c,1);var l=parseInt(a.getKey(),10)<=this.getOriginalCount();if(l){var m=this.getRemovedItems();m.push(JSON.parse(JSON.stringify(j)));}this.setValidCount(this.getValidCount()-1);}this.fireValueChange({"values":V,"type":E,"item":{"value":s,"key":k}});},_suggest:function(e){this.getBinding("suggestionItems").filter(this._filterByValuationResult(e.getParameter("suggestValue")));},_performValueHelp:function(e){var v=this.getValue();if(!this._dialog){this._dialog=sap.ui.xmlfragment("i2d.qm.inspresults.records1.view.fragments.RecordResultsValuationDialog",this);this._dialog.setModel(this.valueHelpModel);this.addDependent(this._dialog);}if(this._dialog.getAggregation("_dialog")!==null){this._dialog.getAggregation("_dialog").setProperty("draggable",true);}this._dialog.getBinding("items").filter(this._filterByValuationResult(v));this._dialog.open(v);},onSearch:function(e){this._dialog.getBinding("items").filter(this._filterByValuationResult(e.getParameter("value")));},reset:function(){var b=this.getBindingContext().getObject();this.setOriginalCount(b.Inspresultvaluecount);var t=this.getTokens();for(var i in b.to_ResultDetails.results4Binding){t[i].setKey(b.to_ResultDetails.results4Binding[i].Inspresultiteminternalid);}},onConfirm:function(e){var c=e.getParameter("selectedContexts");var b=this.getBindingContext().getObject();c.forEach(function(i){var k=(++b.Inspresultvaluecount).toString();var s=i.getObject().ValuationName;var r=this.getBindingContext().getObject().to_ResultDetails.results4Binding;var a=r.length;var R={};this.detailGeneralKeys.forEach(function(n){R[n]=b[n]||"";});r[a]=R;var o=r[a];var C="";this._valuationItems.forEach(function(v){if(s===v.ValuationName){C=v.ValuationKey;}});o.Inspectionvaluationresult=C;o.Inspresultiteminternalid=""+b.Inspresultvaluecount;this.setValidCount(this.getValidCount()+1);this.addToken(new T({key:k,text:s}));var V=this.getTokens().map(function(t){return t.getText();});this.fireValueChange({"values":V,"type":sap.m.Tokenizer.TokenUpdateType.Added,"item":{"value":s,"key":k}});}.bind(this));},_filterByValuationResult:function(v){var a=[];if(v){a.push(new F("ValuationName",sap.ui.model.FilterOperator.Contains,v));}return a;},_onSelect:function(e){var i=e.getSource();if(i.getValue()){var b=i.getBindingContext().getObject();var s=e.getParameter("selectedItem")&&e.getParameter("selectedItem").getProperty("text");if(s){var k=(++b.Inspresultvaluecount).toString();var r=i.getBindingContext().getObject().to_ResultDetails.results4Binding;var a=r.length;var R={};i.detailGeneralKeys.forEach(function(n){R[n]=b[n]||"";});r[a]=R;var o=r[a];var c="";i._valuationItems.forEach(function(v){if(s===v.ValuationName){c=v.ValuationKey;}});o.Inspectionvaluationresult=c;o.Inspresultiteminternalid=""+b.Inspresultvaluecount;this.setValidCount(i.getValidCount()+1);var d=new T({key:k,text:s});i.addToken(d);i.setValue();var V=i.getTokens().map(function(t){return t.getText();});i.fireValueChange({"values":V,"type":sap.m.Tokenizer.TokenUpdateType.Added,"item":{"value":s,"key":k}});}}}});});
