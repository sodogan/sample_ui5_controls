/*
 * Copyright (C) 2009-2018 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/m/MultiInput","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/Sorter","sap/m/Token","i2d/qm/inspresults/records1/model/formatter"],function(M,J,F,S,T,f){"use strict";return M.extend("i2d.qm.inspresults.records1.customcontrol.CodeGroupMultiInput",{metadata:{properties:{"originalCount":{type:"int"},"removedItems":{type:"object",defaultValue:[]}},events:{"valueChange":{}}},formatter:f,renderer:{},init:function(){this.setModel(new J({"results":[]}),"suggestModel");this.setRemovedItems([]);this._bInitialLoading=true;M.prototype.init.apply(this,arguments);},onBeforeRendering:function(){if(!this.constructor.prototype.formatter._oResourceBundle){this.constructor.prototype.formatter._oResourceBundle=this.getModel("i18n").getResourceBundle();}M.prototype.onBeforeRendering.apply(this,arguments);},onAfterRendering:function(){if(this._bInitialLoading){this.options=null;this.tokens=[];var l=this.getParent().getContent()[0]&&this.getParent().getContent()[0].getId();if(l){this.addAriaLabelledBy(l);}this.attachSuggest(this._suggestion);this.attachSuggestionItemSelected(this._onSuggestionItemSelected);this.attachValueHelpRequest(this._performValueHelp);this.addValidator(this._tokenValidator.bind(this));this.attachChange(this._tokenValidator.bind(this));this.attachTokenUpdate(this._tokenUpdate);var b=this.getBindingContext()&&this.getBindingContext().getObject()||{};this.setOriginalCount(b.Inspresultvaluecount);this._oDataModel=this.getModel("serviceModel");this._bInitialLoading=false;}M.prototype.onAfterRendering.apply(this,arguments);},_suggestion:function(e){this.getModel("suggestModel").setProperty("/results",[]);if(this.options){this.getModel("suggestModel").setProperty("/results",this.options.results||[]);}else{this._getOptions(e,function(){this.getModel("suggestModel").setProperty("/results",this.options.results||[]);}.bind(this));}this._filterByGrpCodeAndTxt.call(e.getSource().getBinding("suggestionRows"),e.getParameter("suggestValue"));},_onSuggestionItemSelected:function(e){var i=e.getSource();if(i.getValue()){var b=i.getBindingContext().getObject();var k=(++b.Inspresultvaluecount).toString();var r=e.getParameter("selectedRow").getTable().getSelectedContexts()[0].getObject();var c=this._createEmptyResultObject();c.Inspresultiteminternalid=k+"";c.CharacteristicAttributeCodeGrp=r.CharacteristicAttributeCodeGrp;c.CharacteristicAttributeCode=r.CharacteristicAttributeCode;c.Inspectionvaluationresult=r.CharcAttributeValuation;b.to_ResultDetails.results4Binding.push(c);var t=r.CharacteristicAttributeCodeGrp+" - "+r.CharacteristicAttributeCode;var o=new T({key:k,text:t});i.addToken(o);i.setValue();i.fireValueChange({"type":sap.m.Tokenizer.TokenUpdateType.Added,"removedItems":i.getRemovedItems(),"currentItem":c});}},_performValueHelp:function(e){if(!this._valueHelpDialog){this._valueHelpDialog=sap.ui.xmlfragment("i2d.qm.inspresults.records1.view.fragments.RecordResultsCodeGroupDialog",this);this.addDependent(this._valueHelpDialog);if(this._valueHelpDialog.getAggregation("_dialog")!==null){this._valueHelpDialog.getAggregation("_dialog").setProperty("draggable",true);}if(!this.formatter._oResourceBundle||!this._oResourceBundle){this._oResourceBundle=this.getModel("i18n").getResourceBundle();this.formatter._oResourceBundle=this._oResourceBundle;}}if(this.options){this._valueHelpDialog.setModel(new J(this.options),"groupCodeVH");this._valueHelpDialog.open(this.getValue());this._valueHelpDialog.fireSearch({value:this.getValue()});this._valueHelpDialog._oTable.removeStyleClass("sapMSelectDialogListHide");this._valueHelpDialog._oBusyIndicator.$().css("display","none");}else{this._getOptions(e,function(){this._valueHelpDialog.setModel(new J(this.options),"groupCodeVH");this._valueHelpDialog.fireSearch({value:this.getValue()});this._valueHelpDialog._oTable.removeStyleClass("sapMSelectDialogListHide");this._valueHelpDialog._oBusyIndicator.$().css("display","none");}.bind(this));this._valueHelpDialog.open(this.getValue());this._valueHelpDialog._oTable.addStyleClass("sapMSelectDialogListHide");this._valueHelpDialog._oBusyIndicator.$().css("display","inline-block");}},onConfirm:function(e){var c=e.getParameter("selectedContexts");var b=this.getBindingContext().getObject();c.forEach(function(i){var a=this._createEmptyResultObject();a.Inspresultiteminternalid=++b.Inspresultvaluecount+"";a.CharacteristicAttributeCodeGrp=i.getObject().CharacteristicAttributeCodeGrp;a.CharacteristicAttributeCode=i.getObject().CharacteristicAttributeCode;a.Inspectionvaluationresult=i.getObject().CharcAttributeValuation;b.to_ResultDetails.results4Binding.push(a);this.addToken(new T({key:a.Inspresultiteminternalid,text:a.CharacteristicAttributeCodeGrp+" - "+a.CharacteristicAttributeCode}));this.fireValueChange({"type":sap.m.Tokenizer.TokenUpdateType.Added,"removedItems":this.getRemovedItems(),"currentItem":a});}.bind(this));},onSearch:function(e){this._filterByGrpCodeAndTxt.call(e.getSource().getBinding("items"),e.getParameter("value"));},reset:function(){var b=this.getBindingContext().getObject();this.setOriginalCount(b.Inspresultvaluecount);var t=this.getTokens();for(var i in b.to_ResultDetails.results4Binding){t[i].setKey(b.to_ResultDetails.results4Binding[i].Inspresultiteminternalid);}},_tokenValidator:function(a){var b=this.getBindingContext()&&this.getBindingContext().getObject()||{};var c;var o;var i=a.text?a.text.toUpperCase():this.getValue().toUpperCase();var I=i.lastIndexOf("-");if(I<=0){this.setValue();return M.WaitForAsyncValidation;}o=this._findOptionByTokenString(i);if(!o){this.setValue();return M.WaitForAsyncValidation;}if(a.text){c=this._createEmptyResultObject();c.Inspresultiteminternalid=++b.Inspresultvaluecount+"";c.CharacteristicAttributeCodeGrp=o.CharacteristicAttributeCodeGrp;c.CharacteristicAttributeCode=o.CharacteristicAttributeCode;c.Inspectionvaluationresult=o.CharcAttributeValuation;b.to_ResultDetails.results4Binding.push(c);var t=new T({key:c.Inspresultiteminternalid,text:c.CharacteristicAttributeCodeGrp+" - "+c.CharacteristicAttributeCode});a.asyncCallback(t);}return M.WaitForAsyncValidation;},_tokenUpdate:function(e){var E=e.getParameter("type");var t;var o=sap.m.Tokenizer.TokenUpdateType;var r=this.getBindingContext().getObject().to_ResultDetails.results4Binding;var c;if(E===o.Added){t=e.getParameter("addedTokens")[0];c=this._createEmptyResultObject();c.Inspresultiteminternalid=t.getKey();var s=t.getText().trim();c.CharacteristicAttributeCodeGrp=s.substr(0,s.lastIndexOf("-")).trim();c.CharacteristicAttributeCode=s.substr(s.lastIndexOf("-")+1).trim();var v=(r.length>0)?r[r.length-1].Inspectionvaluationresult:"";c.Inspectionvaluationresult=v;this.fireValueChange({"type":E,"removedItems":this.getRemovedItems(),"currentItem":c});}else if(E===o.Removed){t=e.getParameter("removedTokens")[0];var a=r.length;for(var i=0;i<r.length;i++){var b=parseInt(t.getKey(),10);var d=parseInt(r[i].Inspresultiteminternalid,10);if(b===d){a=i;break;}}c=r[a];r.splice(a,1);if(parseInt(t.getKey(),10)<=this.getOriginalCount()){this.getRemovedItems().push(c);}this.fireValueChange({"type":E,"removedItems":this.getRemovedItems(),"currentItem":c});}},_getOptions:function(e,c){if(!this.options){var s=e.getSource().getBindingContext().getObject();var a=[];a.push(new F("InspectionLot",sap.ui.model.FilterOperator.EQ,s.Inspectionlot));a.push(new F("InspPlanOperationInternalID",sap.ui.model.FilterOperator.EQ,s.Inspplanoperationinternalid));a.push(new F("InspectionCharacteristic",sap.ui.model.FilterOperator.EQ,s.Inspectioncharacteristic));this._oDataModel.read("/C_Chargroupcode_Valuehelp",{filters:a,sorters:[new S("CharacteristicAttributeCode",false)],success:(function(r){this.options=r;if(c){c();}}).bind(this)});}},_filterByGrpCodeAndTxt:function(v){if(!v){this.filter([]);return;}if(v.indexOf("-")>=0){var c=v.substr(0,v.lastIndexOf("-"));var C=v.substr(v.lastIndexOf("-")+1);var s=[new F("CharacteristicAttributeCodeGrp",sap.ui.model.FilterOperator.Contains,c.trim()),new F("CharacteristicAttributeCode",sap.ui.model.FilterOperator.Contains,C.trim())];this.filter(s);if(this.getLength()){return;}}var e=v.trim();var E=[new F({filters:[new F("CharacteristicAttributeCodeGrp",sap.ui.model.FilterOperator.Contains,e),new F("CharacteristicAttributeCode",sap.ui.model.FilterOperator.Contains,e),new F("CharacteristicAttributeCodeTxt",sap.ui.model.FilterOperator.Contains,e)],and:false})];this.filter(E);},_findOptionByTokenString:function(t){var c=t.substr(0,t.lastIndexOf("-"));var C=t.substr(t.lastIndexOf("-")+1);var n=this.options.results.map(function(a){return a.CharacteristicAttributeCodeGrp+" - "+a.CharacteristicAttributeCode;});var i=n.indexOf(c.trim()+" - "+C.trim());if(i!==-1){var o=this.options.results[i];return o;}else{return null;}},_createEmptyResultObject:function(){return{Inspectionresultattribute:"",Inspspecrecordingtype:"",Inspectionresulttext:"",Insprsltfreedefinedtestequip:"",Inspresultiteminternalid:"",Inspectionresultoriginalvalue:"",CharacteristicAttributeCode:"",CharacteristicAttributeCodeGrp:"",Inspectionvaluationresult:"",Inspectionresultmeasuredvalue:"",Inspectionresultitem:""};}});});
